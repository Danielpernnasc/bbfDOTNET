name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - Bookstore_development
      - Bookstore_homolog

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up AWS CLI
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip

    - name: Package application
      run: |
        zip -r Bookstore.zip .

    - name: Upload to S3
      run: |
        aws s3 cp Bookstore.zip s3://your-s3-bucket/Bookstore.zip

    - name: Create application version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name Bookstore_DEVELOPMENT \
          --version-label ${{ github.sha }} \
          --source-bundle S3Bucket="your-s3-bucket",S3Key="Bookstore.zip"

    - name: Update Elastic Beanstalk environment
      run: |
        aws elasticbeanstalk update-environment \
          --environment-name AmbienteDesenvolvimentoAWS-env \
          --version-label ${{ github.sha }}

    - name: Confirm update
      run: |
        aws elasticbeanstalk describe-environments \
          --environment-names AmbienteDesenvolvimentoAWS-env
